import{TextDecoder as e,TextEncoder as t}from"@zxing/text-encoding";import{fromByteArray as r}from"base64-js";var i=class{#e;#t=0;constructor(e){this.#e=new DataView(e.buffer),this.#t=e.byteOffset}get offset(){return this.#t}readUInt8Array(){const e=this.readU32(),t=new Uint8Array(this.#e.buffer,this.#t,e);return this.#t+=e,t}readBool(){const e=this.#e.getUint8(this.#t);return this.#t+=1,0!==e}readByte(){const e=this.#e.getUint8(this.#t);return this.#t+=1,e}readBytes(e){const t=new DataView(this.#e.buffer,this.#t,e);return this.#t+=e,new Uint8Array(t.buffer)}readI8(){const e=this.#e.getInt8(this.#t);return this.#t+=1,e}readU8(){const e=this.#e.getUint8(this.#t);return this.#t+=1,e}readI16(){const e=this.#e.getInt16(this.#t,!0);return this.#t+=2,e}readU16(){const e=this.#e.getUint16(this.#t,!0);return this.#t+=2,e}readI32(){const e=this.#e.getInt32(this.#t,!0);return this.#t+=4,e}readU32(){const e=this.#e.getUint32(this.#t,!0);return this.#t+=4,e}readI64(){const e=this.#e.getBigInt64(this.#t,!0);return this.#t+=8,e}readU64(){const e=this.#e.getBigUint64(this.#t,!0);return this.#t+=8,e}readU128(){const e=this.#e.getBigUint64(this.#t,!0),t=this.#e.getBigUint64(this.#t+8,!0);return this.#t+=16,(t<<BigInt(64))+e}readI128(){const e=this.#e.getBigUint64(this.#t,!0),t=this.#e.getBigInt64(this.#t+8,!0);return this.#t+=16,(t<<BigInt(64))+e}readU256(){const e=this.#e.getBigUint64(this.#t,!0),t=this.#e.getBigUint64(this.#t+8,!0),r=this.#e.getBigUint64(this.#t+16,!0),i=this.#e.getBigUint64(this.#t+24,!0);return this.#t+=32,(i<<BigInt(192))+(r<<BigInt(128))+(t<<BigInt(64))+e}readI256(){const e=this.#e.getBigUint64(this.#t,!0),t=this.#e.getBigUint64(this.#t+8,!0),r=this.#e.getBigUint64(this.#t+16,!0),i=this.#e.getBigInt64(this.#t+24,!0);return this.#t+=32,(i<<BigInt(192))+(r<<BigInt(128))+(t<<BigInt(64))+e}readF32(){const e=this.#e.getFloat32(this.#t,!0);return this.#t+=4,e}readF64(){const e=this.#e.getFloat64(this.#t,!0);return this.#t+=8,e}readString(){const t=this.readU32(),r=new Uint8Array(this.#e.buffer,this.#t,t),i=new e("utf-8").decode(r);return this.#t+=t,i}},s=class{#e;#r;#t=0;constructor(e){this.#e=new Uint8Array(e),this.#r=new DataView(this.#e.buffer)}#i(e){const t=this.#t+e+1;if(t<=this.#e.length)return;let r=2*this.#e.length;r<t&&(r=t);const i=new Uint8Array(r);i.set(this.#e),this.#e=i,this.#r=new DataView(this.#e.buffer)}toBase64(){return r(this.#e.subarray(0,this.#t))}getBuffer(){return this.#e.slice(0,this.#t)}writeUInt8Array(e){const t=e.length;this.#i(4+t),this.writeU32(t),this.#e.set(e,this.#t),this.#t+=e.length}writeBool(e){this.#i(1),this.#r.setUint8(this.#t,e?1:0),this.#t+=1}writeByte(e){this.#i(1),this.#r.setUint8(this.#t,e),this.#t+=1}writeI8(e){this.#i(1),this.#r.setInt8(this.#t,e),this.#t+=1}writeU8(e){this.#i(1),this.#r.setUint8(this.#t,e),this.#t+=1}writeI16(e){this.#i(2),this.#r.setInt16(this.#t,e,!0),this.#t+=2}writeU16(e){this.#i(2),this.#r.setUint16(this.#t,e,!0),this.#t+=2}writeI32(e){this.#i(4),this.#r.setInt32(this.#t,e,!0),this.#t+=4}writeU32(e){this.#i(4),this.#r.setUint32(this.#t,e,!0),this.#t+=4}writeI64(e){this.#i(8),this.#r.setBigInt64(this.#t,e,!0),this.#t+=8}writeU64(e){this.#i(8),this.#r.setBigUint64(this.#t,e,!0),this.#t+=8}writeU128(e){this.#i(16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);this.#r.setBigUint64(this.#t,t,!0),this.#r.setBigUint64(this.#t+8,r,!0),this.#t+=16}writeI128(e){this.#i(16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);this.#r.setBigInt64(this.#t,t,!0),this.#r.setBigInt64(this.#t+8,r,!0),this.#t+=16}writeU256(e){this.#i(32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,i=e>>BigInt(64)&t,s=e>>BigInt(128)&t,n=e>>BigInt(192);this.#r.setBigUint64(this.#t+0,r,!0),this.#r.setBigUint64(this.#t+8,i,!0),this.#r.setBigUint64(this.#t+16,s,!0),this.#r.setBigUint64(this.#t+24,n,!0),this.#t+=32}writeI256(e){this.#i(32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,i=e>>BigInt(64)&t,s=e>>BigInt(128)&t,n=e>>BigInt(192);this.#r.setBigUint64(this.#t+0,r,!0),this.#r.setBigUint64(this.#t+8,i,!0),this.#r.setBigUint64(this.#t+16,s,!0),this.#r.setBigInt64(this.#t+24,n,!0),this.#t+=32}writeF32(e){this.#i(4),this.#r.setFloat32(this.#t,e,!0),this.#t+=4}writeF64(e){this.#i(8),this.#r.setFloat64(this.#t,e,!0),this.#t+=8}writeString(e){const r=(new t).encode(e);this.writeU32(r.length),this.#i(r.length),this.#e.set(r,this.#t),this.#t+=r.length}};function n(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;const r=Object.keys(e),i=Object.keys(t);if(r.length!==i.length)return!1;for(let s of r)if(!i.includes(s)||!n(e[s],t[s]))return!1;return!0}function a(e){return Array.prototype.map.call(e.reverse(),(e=>("00"+e.toString(16)).slice(-2))).join("")}function o(e){e.startsWith("0x")&&(e=e.slice(2));let t=e.match(/.{1,2}/g)||[],r=Uint8Array.from(t.map((e=>parseInt(e,16))));return 32!=r.length?new Uint8Array(0):r.reverse()}function c(e){return function(e){if(16!=e.length)throw new Error(`Uint8Array is not 16 bytes long: ${e}`);return new i(e).readU128()}(o(e))}function p(e){return function(e){if(32!=e.length)throw new Error(`Uint8Array is not 32 bytes long: [${e}]`);return new i(e).readU256()}(o(e))}function u(e){let t=new s(16);return t.writeU128(e),t.getBuffer()}function l(e){let t=new s(32);return t.writeU256(e),t.getBuffer()}var y,h,d=class e{data;get __connection_id__(){return this.data}constructor(e){this.data=e}isZero(){return this.data===BigInt(0)}static nullIfZero(e){return e.isZero()?null:e}static random(){let t=BigInt(0);for(let e=0;e<16;e++)t=t<<BigInt(8)|BigInt(Math.floor(255*Math.random()));return new e(t)}isEqual(e){return this.data==e.data}toHexString(){return a(u(this.data))}toUint8Array(){return u(this.data)}static fromString(t){return new e(c(t))}static fromStringOrNull(t){let r=e.fromString(t);return r.isZero()?null:r}},f=class e{__time_duration_micros__;static MICROS_PER_MILLIS=1000n;get micros(){return this.__time_duration_micros__}get millis(){return Number(this.micros/e.MICROS_PER_MILLIS)}constructor(e){this.__time_duration_micros__=e}static fromMillis(t){return new e(BigInt(t)*e.MICROS_PER_MILLIS)}},g=class e{__timestamp_micros_since_unix_epoch__;static MICROS_PER_MILLIS=1000n;get microsSinceUnixEpoch(){return this.__timestamp_micros_since_unix_epoch__}constructor(e){this.__timestamp_micros_since_unix_epoch__=e}static UNIX_EPOCH=new e(0n);static now(){return e.fromDate(new Date)}static fromDate(t){const r=t.getTime(),i=BigInt(r)*e.MICROS_PER_MILLIS;return new e(i)}toDate(){const t=this.__timestamp_micros_since_unix_epoch__/e.MICROS_PER_MILLIS;if(t>BigInt(Number.MAX_SAFE_INTEGER)||t<BigInt(Number.MIN_SAFE_INTEGER))throw new RangeError("Timestamp is outside of the representable range of JS's Date");return new Date(Number(t))}},T=class e{data;get __identity__(){return this.data}constructor(e){this.data="string"==typeof e?p(e):e}isEqual(e){return this.toHexString()===e.toHexString()}toHexString(){return a(l(this.data))}toUint8Array(){return l(this.data)}static fromString(t){return new e(t)}};(h=y||(y={})).getAlgebraicType=function(){return v.createSumType([new S("Interval",v.createTimeDurationType()),new S("Time",v.createTimestampType())])},h.Interval=e=>({tag:"Interval",value:{__time_duration_micros__:e}}),h.Time=e=>({tag:"Time",value:{__timestamp_micros_since_unix_epoch__:e}}),h.fromValue=function(e){let t=e.asSumValue();switch(t.tag){case 0:return{tag:"Interval",value:{__time_duration_micros__:t.value.asProductValue().elements[0].asBigInt()}};case 1:return{tag:"Time",value:{__timestamp_micros_since_unix_epoch__:t.value.asBigInt()}};default:throw"unreachable"}};var b,m,w=y,S=class{name;algebraicType;constructor(e,t){this.name=e,this.algebraicType=t}},I=class{variants;constructor(e){this.variants=e}serialize=(e,t)=>{if(2==this.variants.length&&"some"===this.variants[0].name&&"none"===this.variants[1].name)null!=t?(e.writeByte(0),this.variants[0].algebraicType.serialize(e,t)):e.writeByte(1);else{let r=t.tag;const i=this.variants.findIndex((e=>e.name===r));if(i<0)throw`Can't serialize a sum type, couldn't find ${t.tag} tag`;e.writeU8(i),this.variants[i].algebraicType.serialize(e,t.value)}};deserialize=e=>{let t=e.readU8();if(2==this.variants.length&&"some"===this.variants[0].name&&"none"===this.variants[1].name){if(0===t)return this.variants[0].algebraicType.deserialize(e);if(1===t)return;throw`Can't deserialize an option type, couldn't find ${t} tag`}{let r=this.variants[t],i=r.algebraicType.deserialize(e);return{tag:r.name,value:i}}}},U=class{name;algebraicType;constructor(e,t){this.name=e,this.algebraicType=t}},A=class{elements;constructor(e){this.elements=e}isEmpty(){return 0===this.elements.length}serialize=(e,t)=>{for(let r of this.elements)r.algebraicType.serialize(e,t[r.name])};intoMapKey(e){if(1===this.elements.length){if("__time_duration_micros__"===this.elements[0].name)return e.__time_duration_micros__;if("__timestamp_micros_since_unix_epoch__"===this.elements[0].name)return e.__timestamp_micros_since_unix_epoch__;if("__identity__"===this.elements[0].name)return e.__identity__;if("__connection_id__"===this.elements[0].name)return e.__connection_id__}const t=new s(10);return this.serialize(t,e),t.toBase64()}deserialize=e=>{let t={};if(1===this.elements.length){if("__time_duration_micros__"===this.elements[0].name)return new f(e.readI64());if("__timestamp_micros_since_unix_epoch__"===this.elements[0].name)return new g(e.readI64());if("__identity__"===this.elements[0].name)return new T(e.readU256());if("__connection_id__"===this.elements[0].name)return new d(e.readU128())}for(let r of this.elements)t[r.name]=r.algebraicType.deserialize(e);return t}},_=class{keyType;valueType;constructor(e,t){this.keyType=e,this.valueType=t}},v=class e{type;type_;#s(e,t){this.type_=t,this.type=void 0===t?ke.None:e}get product(){if(this.type!==ke.ProductType)throw"product type was requested, but the type is not ProductType";return this.type_}set product(e){this.#s(ke.ProductType,e)}get sum(){if(this.type!==ke.SumType)throw"sum type was requested, but the type is not SumType";return this.type_}set sum(e){this.#s(ke.SumType,e)}get array(){if(this.type!==ke.ArrayType)throw"array type was requested, but the type is not ArrayType";return this.type_}set array(e){this.#s(ke.ArrayType,e)}get map(){if(this.type!==ke.MapType)throw"map type was requested, but the type is not MapType";return this.type_}set map(e){this.#s(ke.MapType,e)}static#n(t,r){let i=new e;return i.#s(t,r),i}static createProductType(e){return this.#n(ke.ProductType,new A(e))}static createSumType(e){return this.#n(ke.SumType,new I(e))}static createArrayType(e){return this.#n(ke.ArrayType,e)}static createMapType(e,t){return this.#n(ke.MapType,new _(e,t))}static createBoolType(){return this.#n(ke.Bool,null)}static createI8Type(){return this.#n(ke.I8,null)}static createU8Type(){return this.#n(ke.U8,null)}static createI16Type(){return this.#n(ke.I16,null)}static createU16Type(){return this.#n(ke.U16,null)}static createI32Type(){return this.#n(ke.I32,null)}static createU32Type(){return this.#n(ke.U32,null)}static createI64Type(){return this.#n(ke.I64,null)}static createU64Type(){return this.#n(ke.U64,null)}static createI128Type(){return this.#n(ke.I128,null)}static createU128Type(){return this.#n(ke.U128,null)}static createI256Type(){return this.#n(ke.I256,null)}static createU256Type(){return this.#n(ke.U256,null)}static createF32Type(){return this.#n(ke.F32,null)}static createF64Type(){return this.#n(ke.F64,null)}static createStringType(){return this.#n(ke.String,null)}static createBytesType(){return this.createArrayType(this.createU8Type())}static createOptionType(e){return this.createSumType([new S("some",e),new S("none",this.createProductType([]))])}static createIdentityType(){return this.createProductType([new U("__identity__",this.createU256Type())])}static createConnectionIdType(){return this.createProductType([new U("__connection_id__",this.createU128Type())])}static createScheduleAtType(){return w.getAlgebraicType()}static createTimestampType(){return this.createProductType([new U("__timestamp_micros_since_unix_epoch__",this.createI64Type())])}static createTimeDurationType(){return this.createProductType([new U("__time_duration_micros__",this.createI64Type())])}isProductType(){return this.type===ke.ProductType}isSumType(){return this.type===ke.SumType}isArrayType(){return this.type===ke.ArrayType}isMapType(){return this.type===ke.MapType}#a(){return this.isArrayType()&&this.array.type==ke.U8}#o(e){return this.isProductType()&&1===this.product.elements.length&&(this.product.elements[0].algebraicType.type==ke.U128||this.product.elements[0].algebraicType.type==ke.U256)&&this.product.elements[0].name===e}#c(e){return this.isProductType()&&1===this.product.elements.length&&this.product.elements[0].algebraicType.type===ke.I64&&this.product.elements[0].name===e}isIdentity(){return this.#o("__identity__")}isConnectionId(){return this.#o("__connection_id__")}isScheduleAt(){return this.isSumType()&&2===this.sum.variants.length&&"Interval"===this.sum.variants[0].name&&this.sum.variants[0].algebraicType.type===ke.U64&&"Time"===this.sum.variants[1].name&&this.sum.variants[1].algebraicType.type===ke.U64}isTimestamp(){return this.#c("__timestamp_micros_since_unix_epoch__")}isTimeDuration(){return this.#c("__time_duration_micros__")}intoMapKey(e){switch(this.type){case ke.U8:case ke.U16:case ke.U32:case ke.U64:case ke.U128:case ke.U256:case ke.I8:case ke.I16:case ke.I64:case ke.I128:case ke.F32:case ke.F64:case ke.String:case ke.Bool:return e;case ke.ProductType:return this.product.intoMapKey(e);default:const t=new s(10);return this.serialize(t,e),t.toBase64()}}serialize(e,t){switch(this.type){case ke.ProductType:this.product.serialize(e,t);break;case ke.SumType:this.sum.serialize(e,t);break;case ke.ArrayType:if(this.#a())e.writeUInt8Array(t);else{const r=this.array;e.writeU32(t.length);for(let i of t)r.serialize(e,i)}break;case ke.MapType:throw new Error("not implemented");case ke.Bool:e.writeBool(t);break;case ke.I8:e.writeI8(t);break;case ke.U8:e.writeU8(t);break;case ke.I16:e.writeI16(t);break;case ke.U16:e.writeU16(t);break;case ke.I32:e.writeI32(t);break;case ke.U32:e.writeU32(t);break;case ke.I64:e.writeI64(t);break;case ke.U64:e.writeU64(t);break;case ke.I128:e.writeI128(t);break;case ke.U128:e.writeU128(t);break;case ke.I256:e.writeI256(t);break;case ke.U256:e.writeU256(t);break;case ke.F32:e.writeF32(t);break;case ke.F64:e.writeF64(t);break;case ke.String:e.writeString(t);break;default:throw new Error(`not implemented, ${this.type}`)}}deserialize(e){switch(this.type){case ke.ProductType:return this.product.deserialize(e);case ke.SumType:return this.sum.deserialize(e);case ke.ArrayType:if(this.#a())return e.readUInt8Array();{const t=this.array,r=e.readU32();let i=[];for(let s=0;s<r;s++)i.push(t.deserialize(e));return i}case ke.MapType:throw new Error("not implemented");case ke.Bool:return e.readBool();case ke.I8:return e.readI8();case ke.U8:return e.readU8();case ke.I16:return e.readI16();case ke.U16:return e.readU16();case ke.I32:return e.readI32();case ke.U32:return e.readU32();case ke.I64:return e.readI64();case ke.U64:return e.readU64();case ke.I128:return e.readI128();case ke.U128:return e.readU128();case ke.U256:return e.readU256();case ke.F32:return e.readF32();case ke.F64:return e.readF64();case ke.String:return e.readString();default:throw new Error(`not implemented, ${this.type}`)}}};b=v||(v={}),(m=b.Type||(b.Type={})).SumType="SumType",m.ProductType="ProductType",m.ArrayType="ArrayType",m.MapType="MapType",m.Bool="Bool",m.I8="I8",m.U8="U8",m.I16="I16",m.U16="U16",m.I32="I32",m.U32="U32",m.I64="I64",m.U64="U64",m.I128="I128",m.U128="U128",m.I256="I256",m.U256="U256",m.F32="F32",m.F64="F64",m.String="String",m.None="None";var z,B,F,M,E,x,C,O,k,P,q,R,N,D,$,L,j,W,H,Q,V,Z,G,K,X,J,Y,ee,te,re,ie,se,ne,ae,oe,ce,pe,ue,le,ye,he,de,fe,ge,Te,be,me,we,Se,Ie,Ue,Ae,_e,ve,ze,Be,Fe,Me,Ee,xe,Ce,Oe,ke=v.Type,Pe=class{tag;value;constructor(e,t){this.tag=e,this.value=t}static deserialize(e,t){return t.readSum(e)}},qe=class{elements;constructor(e){this.elements=e}static deserialize(e,t){return t.readProduct(e)}},Re=class{value;constructor(e){if(void 0===e)throw"value is undefined";this.value=e}callMethod(e){return this[e]()}static deserialize(e,t){switch(e.type){case v.Type.ProductType:return new this(qe.deserialize(e.product,t));case v.Type.SumType:return new this(Pe.deserialize(e.sum,t));case v.Type.ArrayType:let r=e.array;return r.type===v.Type.U8?new this(t.readUInt8Array()):new this(t.readArray(r));case v.Type.MapType:let i=e.map;return new this(t.readMap(i.keyType,i.valueType));case v.Type.Bool:return new this(t.readBool());case v.Type.I8:return new this(t.readI8());case v.Type.U8:return new this(t.readU8());case v.Type.I16:return new this(t.readI16());case v.Type.U16:return new this(t.readU16());case v.Type.I32:return new this(t.readI32());case v.Type.U32:return new this(t.readU32());case v.Type.I64:return new this(t.readI64());case v.Type.U64:return new this(t.readU64());case v.Type.I128:return new this(t.readI128());case v.Type.U128:return new this(t.readU128());case v.Type.String:return new this(t.readString());default:throw new Error(`not implemented, ${e.type}`)}}asProductValue(){return this.value}asField(e){return this.asProductValue().elements[e]}asSumValue(){return this.value}asArray(){return this.value}asMap(){return this.value}asString(){return this.value}asBoolean(){return this.value}asNumber(){return this.value}asBytes(){return this.value}asBigInt(){return this.value}asIdentity(){return new T(this.asField(0).asBigInt())}asConnectionId(){return new d(this.asField(0).asBigInt())}asScheduleAt(){return y.fromValue(this)}};(B=z||(z={})).FixedSize=e=>({tag:"FixedSize",value:e}),B.RowOffsets=e=>({tag:"RowOffsets",value:e}),B.getTypeScriptAlgebraicType=function(){return v.createSumType([new S("FixedSize",v.createU16Type()),new S("RowOffsets",v.createArrayType(v.createU64Type()))])},B.serialize=function(e,t){B.getTypeScriptAlgebraicType().serialize(e,t)},B.deserialize=function(e){return B.getTypeScriptAlgebraicType().deserialize(e)},(M=F||(F={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("sizeHint",z.getTypeScriptAlgebraicType()),new U("rowsData",v.createArrayType(v.createU8Type()))])},M.serialize=function(e,t){M.getTypeScriptAlgebraicType().serialize(e,t)},M.deserialize=function(e){return M.getTypeScriptAlgebraicType().deserialize(e)},(x=E||(E={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("reducer",v.createStringType()),new U("args",v.createArrayType(v.createU8Type())),new U("requestId",v.createU32Type()),new U("flags",v.createU8Type())])},x.serialize=function(e,t){x.getTypeScriptAlgebraicType().serialize(e,t)},x.deserialize=function(e){return x.getTypeScriptAlgebraicType().deserialize(e)},(O=C||(C={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("queryStrings",v.createArrayType(v.createStringType())),new U("requestId",v.createU32Type())])},O.serialize=function(e,t){O.getTypeScriptAlgebraicType().serialize(e,t)},O.deserialize=function(e){return O.getTypeScriptAlgebraicType().deserialize(e)},(P=k||(k={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("messageId",v.createArrayType(v.createU8Type())),new U("queryString",v.createStringType())])},P.serialize=function(e,t){P.getTypeScriptAlgebraicType().serialize(e,t)},P.deserialize=function(e){return P.getTypeScriptAlgebraicType().deserialize(e)},(R=q||(q={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("id",v.createU32Type())])},R.serialize=function(e,t){R.getTypeScriptAlgebraicType().serialize(e,t)},R.deserialize=function(e){return R.getTypeScriptAlgebraicType().deserialize(e)},(D=N||(N={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("query",v.createStringType()),new U("requestId",v.createU32Type()),new U("queryId",q.getTypeScriptAlgebraicType())])},D.serialize=function(e,t){D.getTypeScriptAlgebraicType().serialize(e,t)},D.deserialize=function(e){return D.getTypeScriptAlgebraicType().deserialize(e)},(L=$||($={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("queryStrings",v.createArrayType(v.createStringType())),new U("requestId",v.createU32Type()),new U("queryId",q.getTypeScriptAlgebraicType())])},L.serialize=function(e,t){L.getTypeScriptAlgebraicType().serialize(e,t)},L.deserialize=function(e){return L.getTypeScriptAlgebraicType().deserialize(e)},(W=j||(j={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("requestId",v.createU32Type()),new U("queryId",q.getTypeScriptAlgebraicType())])},W.serialize=function(e,t){W.getTypeScriptAlgebraicType().serialize(e,t)},W.deserialize=function(e){return W.getTypeScriptAlgebraicType().deserialize(e)},(Q=H||(H={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("requestId",v.createU32Type()),new U("queryId",q.getTypeScriptAlgebraicType())])},Q.serialize=function(e,t){Q.getTypeScriptAlgebraicType().serialize(e,t)},Q.deserialize=function(e){return Q.getTypeScriptAlgebraicType().deserialize(e)},(Z=V||(V={})).CallReducer=e=>({tag:"CallReducer",value:e}),Z.Subscribe=e=>({tag:"Subscribe",value:e}),Z.OneOffQuery=e=>({tag:"OneOffQuery",value:e}),Z.SubscribeSingle=e=>({tag:"SubscribeSingle",value:e}),Z.SubscribeMulti=e=>({tag:"SubscribeMulti",value:e}),Z.Unsubscribe=e=>({tag:"Unsubscribe",value:e}),Z.UnsubscribeMulti=e=>({tag:"UnsubscribeMulti",value:e}),Z.getTypeScriptAlgebraicType=function(){return v.createSumType([new S("CallReducer",E.getTypeScriptAlgebraicType()),new S("Subscribe",C.getTypeScriptAlgebraicType()),new S("OneOffQuery",k.getTypeScriptAlgebraicType()),new S("SubscribeSingle",N.getTypeScriptAlgebraicType()),new S("SubscribeMulti",$.getTypeScriptAlgebraicType()),new S("Unsubscribe",j.getTypeScriptAlgebraicType()),new S("UnsubscribeMulti",H.getTypeScriptAlgebraicType())])},Z.serialize=function(e,t){Z.getTypeScriptAlgebraicType().serialize(e,t)},Z.deserialize=function(e){return Z.getTypeScriptAlgebraicType().deserialize(e)},(K=G||(G={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("deletes",F.getTypeScriptAlgebraicType()),new U("inserts",F.getTypeScriptAlgebraicType())])},K.serialize=function(e,t){K.getTypeScriptAlgebraicType().serialize(e,t)},K.deserialize=function(e){return K.getTypeScriptAlgebraicType().deserialize(e)},(J=X||(X={})).Uncompressed=e=>({tag:"Uncompressed",value:e}),J.Brotli=e=>({tag:"Brotli",value:e}),J.Gzip=e=>({tag:"Gzip",value:e}),J.getTypeScriptAlgebraicType=function(){return v.createSumType([new S("Uncompressed",G.getTypeScriptAlgebraicType()),new S("Brotli",v.createArrayType(v.createU8Type())),new S("Gzip",v.createArrayType(v.createU8Type()))])},J.serialize=function(e,t){J.getTypeScriptAlgebraicType().serialize(e,t)},J.deserialize=function(e){return J.getTypeScriptAlgebraicType().deserialize(e)},(ee=Y||(Y={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("tableId",v.createU32Type()),new U("tableName",v.createStringType()),new U("numRows",v.createU64Type()),new U("updates",v.createArrayType(X.getTypeScriptAlgebraicType()))])},ee.serialize=function(e,t){ee.getTypeScriptAlgebraicType().serialize(e,t)},ee.deserialize=function(e){return ee.getTypeScriptAlgebraicType().deserialize(e)},(re=te||(te={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("tables",v.createArrayType(Y.getTypeScriptAlgebraicType()))])},re.serialize=function(e,t){re.getTypeScriptAlgebraicType().serialize(e,t)},re.deserialize=function(e){return re.getTypeScriptAlgebraicType().deserialize(e)},(se=ie||(ie={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("databaseUpdate",te.getTypeScriptAlgebraicType()),new U("requestId",v.createU32Type()),new U("totalHostExecutionDuration",v.createTimeDurationType())])},se.serialize=function(e,t){se.getTypeScriptAlgebraicType().serialize(e,t)},se.deserialize=function(e){return se.getTypeScriptAlgebraicType().deserialize(e)},(ae=ne||(ne={})).Committed=e=>({tag:"Committed",value:e}),ae.Failed=e=>({tag:"Failed",value:e}),ae.OutOfEnergy={tag:"OutOfEnergy"},ae.getTypeScriptAlgebraicType=function(){return v.createSumType([new S("Committed",te.getTypeScriptAlgebraicType()),new S("Failed",v.createStringType()),new S("OutOfEnergy",v.createProductType([]))])},ae.serialize=function(e,t){ae.getTypeScriptAlgebraicType().serialize(e,t)},ae.deserialize=function(e){return ae.getTypeScriptAlgebraicType().deserialize(e)},(ce=oe||(oe={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("reducerName",v.createStringType()),new U("reducerId",v.createU32Type()),new U("args",v.createArrayType(v.createU8Type())),new U("requestId",v.createU32Type())])},ce.serialize=function(e,t){ce.getTypeScriptAlgebraicType().serialize(e,t)},ce.deserialize=function(e){return ce.getTypeScriptAlgebraicType().deserialize(e)},(ue=pe||(pe={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("quanta",v.createU128Type())])},ue.serialize=function(e,t){ue.getTypeScriptAlgebraicType().serialize(e,t)},ue.deserialize=function(e){return ue.getTypeScriptAlgebraicType().deserialize(e)},(ye=le||(le={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("status",ne.getTypeScriptAlgebraicType()),new U("timestamp",v.createTimestampType()),new U("callerIdentity",v.createIdentityType()),new U("callerConnectionId",v.createConnectionIdType()),new U("reducerCall",oe.getTypeScriptAlgebraicType()),new U("energyQuantaUsed",pe.getTypeScriptAlgebraicType()),new U("totalHostExecutionDuration",v.createTimeDurationType())])},ye.serialize=function(e,t){ye.getTypeScriptAlgebraicType().serialize(e,t)},ye.deserialize=function(e){return ye.getTypeScriptAlgebraicType().deserialize(e)},(de=he||(he={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("requestId",v.createU32Type()),new U("update",te.getTypeScriptAlgebraicType())])},de.serialize=function(e,t){de.getTypeScriptAlgebraicType().serialize(e,t)},de.deserialize=function(e){return de.getTypeScriptAlgebraicType().deserialize(e)},(ge=fe||(fe={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("identity",v.createIdentityType()),new U("token",v.createStringType()),new U("connectionId",v.createConnectionIdType())])},ge.serialize=function(e,t){ge.getTypeScriptAlgebraicType().serialize(e,t)},ge.deserialize=function(e){return ge.getTypeScriptAlgebraicType().deserialize(e)},(be=Te||(Te={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("tableName",v.createStringType()),new U("rows",F.getTypeScriptAlgebraicType())])},be.serialize=function(e,t){be.getTypeScriptAlgebraicType().serialize(e,t)},be.deserialize=function(e){return be.getTypeScriptAlgebraicType().deserialize(e)},(we=me||(me={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("messageId",v.createArrayType(v.createU8Type())),new U("error",v.createOptionType(v.createStringType())),new U("tables",v.createArrayType(Te.getTypeScriptAlgebraicType())),new U("totalHostExecutionDuration",v.createTimeDurationType())])},we.serialize=function(e,t){we.getTypeScriptAlgebraicType().serialize(e,t)},we.deserialize=function(e){return we.getTypeScriptAlgebraicType().deserialize(e)},(Ie=Se||(Se={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("tableId",v.createU32Type()),new U("tableName",v.createStringType()),new U("tableRows",Y.getTypeScriptAlgebraicType())])},Ie.serialize=function(e,t){Ie.getTypeScriptAlgebraicType().serialize(e,t)},Ie.deserialize=function(e){return Ie.getTypeScriptAlgebraicType().deserialize(e)},(Ae=Ue||(Ue={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("requestId",v.createU32Type()),new U("totalHostExecutionDurationMicros",v.createU64Type()),new U("queryId",q.getTypeScriptAlgebraicType()),new U("rows",Se.getTypeScriptAlgebraicType())])},Ae.serialize=function(e,t){Ae.getTypeScriptAlgebraicType().serialize(e,t)},Ae.deserialize=function(e){return Ae.getTypeScriptAlgebraicType().deserialize(e)},(ve=_e||(_e={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("requestId",v.createU32Type()),new U("totalHostExecutionDurationMicros",v.createU64Type()),new U("queryId",q.getTypeScriptAlgebraicType()),new U("rows",Se.getTypeScriptAlgebraicType())])},ve.serialize=function(e,t){ve.getTypeScriptAlgebraicType().serialize(e,t)},ve.deserialize=function(e){return ve.getTypeScriptAlgebraicType().deserialize(e)},(Be=ze||(ze={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("totalHostExecutionDurationMicros",v.createU64Type()),new U("requestId",v.createOptionType(v.createU32Type())),new U("queryId",v.createOptionType(v.createU32Type())),new U("tableId",v.createOptionType(v.createU32Type())),new U("error",v.createStringType())])},Be.serialize=function(e,t){Be.getTypeScriptAlgebraicType().serialize(e,t)},Be.deserialize=function(e){return Be.getTypeScriptAlgebraicType().deserialize(e)},(Me=Fe||(Fe={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("requestId",v.createU32Type()),new U("totalHostExecutionDurationMicros",v.createU64Type()),new U("queryId",q.getTypeScriptAlgebraicType()),new U("update",te.getTypeScriptAlgebraicType())])},Me.serialize=function(e,t){Me.getTypeScriptAlgebraicType().serialize(e,t)},Me.deserialize=function(e){return Me.getTypeScriptAlgebraicType().deserialize(e)},(xe=Ee||(Ee={})).getTypeScriptAlgebraicType=function(){return v.createProductType([new U("requestId",v.createU32Type()),new U("totalHostExecutionDurationMicros",v.createU64Type()),new U("queryId",q.getTypeScriptAlgebraicType()),new U("update",te.getTypeScriptAlgebraicType())])},xe.serialize=function(e,t){xe.getTypeScriptAlgebraicType().serialize(e,t)},xe.deserialize=function(e){return xe.getTypeScriptAlgebraicType().deserialize(e)},(Oe=Ce||(Ce={})).InitialSubscription=e=>({tag:"InitialSubscription",value:e}),Oe.TransactionUpdate=e=>({tag:"TransactionUpdate",value:e}),Oe.TransactionUpdateLight=e=>({tag:"TransactionUpdateLight",value:e}),Oe.IdentityToken=e=>({tag:"IdentityToken",value:e}),Oe.OneOffQueryResponse=e=>({tag:"OneOffQueryResponse",value:e}),Oe.SubscribeApplied=e=>({tag:"SubscribeApplied",value:e}),Oe.UnsubscribeApplied=e=>({tag:"UnsubscribeApplied",value:e}),Oe.SubscriptionError=e=>({tag:"SubscriptionError",value:e}),Oe.SubscribeMultiApplied=e=>({tag:"SubscribeMultiApplied",value:e}),Oe.UnsubscribeMultiApplied=e=>({tag:"UnsubscribeMultiApplied",value:e}),Oe.getTypeScriptAlgebraicType=function(){return v.createSumType([new S("InitialSubscription",ie.getTypeScriptAlgebraicType()),new S("TransactionUpdate",le.getTypeScriptAlgebraicType()),new S("TransactionUpdateLight",he.getTypeScriptAlgebraicType()),new S("IdentityToken",fe.getTypeScriptAlgebraicType()),new S("OneOffQueryResponse",me.getTypeScriptAlgebraicType()),new S("SubscribeApplied",Ue.getTypeScriptAlgebraicType()),new S("UnsubscribeApplied",_e.getTypeScriptAlgebraicType()),new S("SubscriptionError",ze.getTypeScriptAlgebraicType()),new S("SubscribeMultiApplied",Fe.getTypeScriptAlgebraicType()),new S("UnsubscribeMultiApplied",Ee.getTypeScriptAlgebraicType())])},Oe.serialize=function(e,t){Oe.getTypeScriptAlgebraicType().serialize(e,t)},Oe.deserialize=function(e){return Oe.getTypeScriptAlgebraicType().deserialize(e)};var Ne=class{#p=new Map;on(e,t){let r=this.#p.get(e);r||(r=new Set,this.#p.set(e,r)),r.add(t)}off(e,t){let r=this.#p.get(e);r&&r.delete(t)}emit(e,...t){let r=this.#p.get(e);if(r)for(let e of r)e(...t)}},De={component:"📦",info:"ℹ️",warn:"⚠️",error:"❌",debug:"🐛"},$e={component:"color: #fff; background-color: #8D6FDD; padding: 2px 5px; border-radius: 3px;",info:"color: #fff; background-color: #007bff; padding: 2px 5px; border-radius: 3px;",warn:"color: #fff; background-color: #ffc107; padding: 2px 5px; border-radius: 3px;",error:"color: #fff; background-color: #dc3545; padding: 2px 5px; border-radius: 3px;",debug:"color: #fff; background-color: #28a745; padding: 2px 5px; border-radius: 3px;"},Le={component:"color: #8D6FDD;",info:"color: #007bff;",warn:"color: #ffc107;",error:"color: #dc3545;",debug:"color: #28a745;"},je=(e,t)=>{console.log(`%c${De[e]} ${e.toUpperCase()}%c ${t}`,$e[e],Le[e])},We=class{rows;tableTypeInfo;emitter;constructor(e){this.tableTypeInfo=e,this.rows=new Map,this.emitter=new Ne}count(){return this.rows.size}iter(){return Array.from(this.rows.values()).map((([e])=>e))}applyOperations=(e,t)=>{const r=[];if(void 0!==this.tableTypeInfo.primaryKeyInfo){const i=new Map,s=new Map;for(const t of e)if("insert"===t.type){const[e,r]=i.get(t.rowId)||[t,0];i.set(t.rowId,[t,r+1])}else{const[e,r]=s.get(t.rowId)||[t,0];s.set(t.rowId,[t,r+1])}for(const[e,[n,a]]of i){const i=s.get(e);if(i){const[o,c]=i,p=a-c,u=this.update(t,e,n.row,p);u&&r.push(u),s.delete(e)}else{const e=this.insert(t,n,a);e&&r.push(e)}}for(const[e,i]of s.values()){const s=this.delete(t,e,i);s&&r.push(s)}}else for(const i of e)if("insert"===i.type){const e=this.insert(t,i);e&&r.push(e)}else{const e=this.delete(t,i);e&&r.push(e)}return r};update=(e,t,r,i=0)=>{const s=this.rows.get(t);if(!s)return void je("error",`Updating a row that was not present in the cache. Table: ${this.tableTypeInfo.tableName}, RowId: ${t}`);const[n,a]=s,o=Math.max(1,a+i);if(!(a+i<=0))return this.rows.set(t,[r,o]),0===a?(je("error",`Updating a row id in table ${this.tableTypeInfo.tableName} which was not present in the cache (rowId: ${t})`),{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,r)}}):{type:"update",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("update",e,n,r)}};je("error",`Negative reference count for in table ${this.tableTypeInfo.tableName} row ${t} (${a} + ${i})`)};insert=(e,t,r=1)=>{const[i,s]=this.rows.get(t.rowId)||[t.row,0];if(this.rows.set(t.rowId,[t.row,s+r]),0===s)return{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,t.row)}}};delete=(e,t,r=1)=>{const[i,s]=this.rows.get(t.rowId)||[t.row,0];if(0!==s)return s<=r?(this.rows.delete(t.rowId),{type:"delete",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("delete",e,t.row)}}):void this.rows.set(t.rowId,[t.row,s-r]);je("warn","Deleting a row that was not present in the cache")};onInsert=e=>{this.emitter.on("insert",e)};onDelete=e=>{this.emitter.on("delete",e)};onUpdate=e=>{this.emitter.on("update",e)};removeOnInsert=e=>{this.emitter.off("insert",e)};removeOnDelete=e=>{this.emitter.off("delete",e)};removeOnUpdate=e=>{this.emitter.off("update",e)}},He=class{tables;constructor(){this.tables=new Map}getTable(e){const t=this.tables.get(e);if(!t)throw console.error("The table has not been registered for this client. Please register the table before using it. If you have registered global tables using the SpacetimeDBClient.registerTables() or `registerTable()` method, please make sure that is executed first!"),new Error(`Table ${e} does not exist`);return t}getOrCreateTable(e){let t;return this.tables.has(e.tableName)?t=this.tables.get(e.tableName):(t=new We(e),this.tables.set(e.tableName,t)),t}};var Qe=class e{major;minor;patch;preRelease;buildInfo;constructor(e,t,r,i=null,s=null){this.major=e,this.minor=t,this.patch=r,this.preRelease=i,this.buildInfo=s}toString(){let e=`${this.major}.${this.minor}.${this.patch}`;return this.preRelease&&(e+=`-${this.preRelease.join(".")}`),this.buildInfo&&(e+=`+${this.buildInfo}`),e}compare(e){return this.major!==e.major?this.major-e.major:this.minor!==e.minor?this.minor-e.minor:this.patch!==e.patch?this.patch-e.patch:this.preRelease&&e.preRelease?function(e,t){const r=Math.min(e.length,t.length);for(let i=0;i<r;i++){const r=e[i],s=t[i];if(r!==s)return"number"==typeof r&&"number"==typeof s?r-s:"string"==typeof r&&"string"==typeof s?r.localeCompare(s):"string"==typeof r?1:-1}return e.length-t.length}(this.preRelease,e.preRelease):this.preRelease||e.preRelease?-1:0}clone(){return new e(this.major,this.minor,this.patch,this.preRelease?[...this.preRelease]:null,this.buildInfo)}static parseVersionString(t){const r=t.match(/^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?(?:\+([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?$/);if(!r)throw new Error(`Invalid version string: ${t}`);const i=parseInt(r[1],10),s=parseInt(r[2],10),n=parseInt(r[3],10),a=r[4]?r[4].split(".").map((e=>isNaN(Number(e))?e:Number(e))):null,o=r[5]||null;return new e(i,s,n,a,o)}},Ve=new Qe(1,2,0);function Ze(e){return`Module code was generated with an incompatible version of the spacetimedb cli (${e}).  Update the cli version to at least ${Ve.toString()} and regenerate the bindings. You can upgrade to the latest cli version by running: spacetime version upgrade`}async function Ge(e,t,r=131072){let i=0;const s=new ReadableStream({pull(t){if(i<e.length){const s=e.subarray(i,Math.min(i+r,e.length));t.enqueue(s),i+=r}else t.close()}}),n=new DecompressionStream(t),a=s.pipeThrough(n).getReader(),o=[];let c,p=0;for(;!(c=await a.read()).done;)o.push(c.value),p+=c.value.length;const u=new Uint8Array(p);let l=0;for(const e of o)u.set(e,l),l+=e.length;return u}var Ke=class e{onclose;onopen;onmessage;onerror;#u;async#l(e){const t=new Uint8Array(e.data);let r;if(0===t[0])r=t.slice(1);else{if(1===t[0])throw new Error("Brotli Compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");if(2!==t[0])throw new Error("Unexpected Compression Algorithm. Please use `gzip` or `none`");r=await Ge(t.slice(1),"gzip")}this.onmessage?.({data:r})}#y(e){this.onopen?.(e)}#h(e){this.onerror?.(e)}send(e){this.#u.send(e)}close(){this.#u.close()}constructor(e){this.onmessage=void 0,this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,e.onmessage=this.#l.bind(this),e.onerror=this.#h.bind(this),e.onclose=this.#h.bind(this),e.onopen=this.#y.bind(this),e.binaryType="arraybuffer",this.#u=e}static async createWebSocketFn({url:t,nameOrAddress:r,wsProtocol:i,authToken:s,compression:n,lightMode:a}){const o=new Headers;let c,p;if(c="false"===import.meta.env.BROWSER?"WebSocket"in globalThis?WebSocket:(await import("undici")).WebSocket:WebSocket,s){o.set("Authorization",`Bearer ${s}`);const e=new URL("v1/identity/websocket-token",t);e.protocol="wss:"===t.protocol?"https:":"http:";const r=await fetch(e,{method:"POST",headers:o});if(!r.ok)return Promise.reject(new Error(`Failed to verify token: ${r.statusText}`));{const{token:e}=await r.json();p=e}}const u=new URL(`v1/database/${r}/subscribe`,t);p&&u.searchParams.set("token",p),u.searchParams.set("compression","gzip"===n?"Gzip":"None"),a&&u.searchParams.set("light","true");const l=new c(u.toString(),i);return new e(l)}},Xe=class{constructor(e,t){this.remoteModule=e,this.dbConnectionConstructor=t,this.#d=Ke.createWebSocketFn}#f;#g;#T;#b;#m=new Ne;#w="gzip";#S=!1;#d;withUri(e){return this.#f=new URL(e),this}withModuleName(e){return this.#g=e,this}withToken(e){return this.#b=e,this}withWSFn(e){return this.#d=e,this}withCompression(e){return this.#w=e,this}withLightMode(e){return this.#S=e,this}onConnect(e){return this.#m.on("connect",e),this}onConnectError(e){return this.#m.on("connectError",e),this}onDisconnect(e){return this.#m.on("disconnect",e),this}build(){if(!this.#f)throw new Error("URI is required to connect to SpacetimeDB");if(!this.#g)throw new Error("Database name or address is required to connect to SpacetimeDB");return function(e){if(void 0===e)throw new Error(Ze(e));if(Qe.parseVersionString(e).compare(Ve)<0)throw new Error(Ze(e))}(this.remoteModule.versionInfo?.cliVersion),this.dbConnectionConstructor(new rt({uri:this.#f,nameOrAddress:this.#g,identity:this.#T,token:this.#b,emitter:this.#m,compression:this.#w,lightMode:this.#S,createWSFn:this.#d,remoteModule:this.remoteModule}))}},Je=class{constructor(e){this.db=e}#I=void 0;#U=void 0;onApplied(e){return this.#I=e,this}onError(e){return this.#U=e,this}subscribe(e){const t=Array.isArray(e)?e:[e];if(0===t.length)throw new Error("Subscriptions must have at least one query");return new et(this.db,t,this.#I,this.#U)}subscribeToAllTables(){this.subscribe("SELECT * FROM *")}},Ye=class{subscriptions=new Map},et=class{constructor(e,t,r,i){this.db=e,this.#m.on("applied",(e=>{this.#A=!0,r&&r(e)})),this.#m.on("error",((e,t)=>{this.#A=!1,this.#_=!0,i&&i(e,t)})),this.#v=this.db.registerSubscription(this,this.#m,t)}#v;#z=!1;#_=!1;#A=!1;#m=new Ne;unsubscribe(){if(this.#z)throw new Error("Unsubscribe has already been called");this.#z=!0,this.db.unregisterSubscription(this.#v),this.#m.on("end",(e=>{this.#_=!0,this.#A=!1}))}unsubscribeThen(e){if(this.#_)throw new Error("Subscription has already ended");if(this.#z)throw new Error("Unsubscribe has already been called");this.#z=!0,this.db.unregisterSubscription(this.#v),this.#m.on("end",(t=>{this.#_=!0,this.#A=!1,e(t)}))}isEnded(){return this.#_}isActive(){return this.#A}};function tt(e){switch(e){case"FullUpdate":return 0;case"NoSuccessNotify":return 1}}var rt=class{isActive=!1;identity=void 0;token=void 0;db;reducers;setReducerFlags;connectionId=d.random();#v=0;#m;#B=new Ne;#I;#F;#M=Promise.resolve();#E=new Ye;clientCache;ws;wsPromise;constructor({uri:e,nameOrAddress:t,identity:r,token:i,emitter:s,remoteModule:n,createWSFn:a,compression:o,lightMode:c}){je("info","Connecting to SpacetimeDB WS...");let p=new URL(e.toString());/^wss?:/.test(e.protocol)||(p.protocol="https:"===p.protocol?"wss:":"ws:"),this.identity=r,this.token=i,this.#F=n,this.#m=s;let u=this.connectionId.toHexString();p.searchParams.set("connection_id",u),this.clientCache=new He,this.db=this.#F.dbViewConstructor(this),this.setReducerFlags=this.#F.setReducerFlagsConstructor(),this.reducers=this.#F.reducersConstructor(this,this.setReducerFlags),this.wsPromise=a({url:p,nameOrAddress:t,wsProtocol:"v1.bsatn.spacetimedb",authToken:i,compression:o,lightMode:c}).then((e=>(this.ws=e,this.ws.onclose=()=>{this.#m.emit("disconnect",this)},this.ws.onerror=e=>{this.#m.emit("connectError",this,e)},this.ws.onopen=this.#y.bind(this),this.ws.onmessage=this.#l.bind(this),e))).catch((e=>{je("error","Error connecting to SpacetimeDB WS"),this.#m.emit("connectError",this,e)}))}#x=()=>{const e=this.#v;return this.#v+=1,e};subscriptionBuilder=()=>new Je(this);registerSubscription(e,t,r){const i=this.#x();return this.#E.subscriptions.set(i,{handle:e,emitter:t}),this.#C(V.SubscribeMulti({queryStrings:r,queryId:{id:i},requestId:0})),i}unregisterSubscription(e){this.#C(V.UnsubscribeMulti({queryId:{id:e},requestId:0}))}async#O(e){const t=(e,t,s)=>{const n=s.rowsData,a=new i(n),o=[],c=this.#F.tables[t].rowType,p=this.#F.tables[t].primaryKeyInfo;for(;a.offset<n.length+n.byteOffset;){const t=a.offset,i=c.deserialize(a);let s;if(void 0!==p)s=p.colType.intoMapKey(i[p.colName]);else{const e=n.subarray(t-n.byteOffset,a.offset-n.byteOffset);s=r(e)}o.push({type:e,rowId:s,row:i})}return o},s=async e=>{const r=e.tableName;let s=[];for(const n of e.updates){let e;if("Gzip"===n.tag){const t=await Ge(n.value,"gzip");e=G.deserialize(new i(t))}else{if("Brotli"===n.tag)throw new Error("Brotli compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");e=n.value}s=s.concat(t("insert",r,e.inserts)),s=s.concat(t("delete",r,e.deletes))}return{tableName:r,operations:s}},n=async e=>{const t=[];for(const r of e.tables)t.push(await s(r));return t};switch(e.tag){case"InitialSubscription":{const t=e.value.databaseUpdate;return{tag:"InitialSubscription",tableUpdates:await n(t)}}case"TransactionUpdateLight":{const t=e.value.update;return{tag:"TransactionUpdateLight",tableUpdates:await n(t)}}case"TransactionUpdate":{const t=e.value,r=t.callerIdentity,i=d.nullIfZero(t.callerConnectionId),s=t.reducerCall.reducerName,a=t.reducerCall.args,o=t.energyQuantaUsed;let c,p,u="";switch(t.status.tag){case"Committed":c=await n(t.status.value);break;case"Failed":c=[],u=t.status.value;break;case"OutOfEnergy":c=[]}if("<none>"===s){let e=u;return void console.error(`Received an error from the database: ${e}`)}""!==s&&(p={reducerName:s,args:a});return{tag:"TransactionUpdate",tableUpdates:c,identity:r,connectionId:i,reducerInfo:p,status:t.status,energyConsumed:o.quanta,message:u,timestamp:t.timestamp}}case"IdentityToken":return{tag:"IdentityToken",identity:e.value.identity,token:e.value.token,connectionId:e.value.connectionId};case"OneOffQueryResponse":throw new Error(`TypeScript SDK never sends one-off queries, but got OneOffQueryResponse ${e}`);case"SubscribeMultiApplied":{const t=await n(e.value.update);return{tag:"SubscribeApplied",queryId:e.value.queryId.id,tableUpdates:t}}case"UnsubscribeMultiApplied":{const t=await n(e.value.update);return{tag:"UnsubscribeApplied",queryId:e.value.queryId.id,tableUpdates:t}}case"SubscriptionError":return{tag:"SubscriptionError",queryId:e.value.queryId,error:e.value.error}}}#C(e){this.wsPromise.then((t=>{if(t){const r=new s(1024);V.serialize(r,e);const i=r.getBuffer();t.send(i)}}))}#y(){this.isActive=!0}#k(e,t){let r=[];for(let i of e){const e=i.tableName,s=this.#F.tables[e],n=this.clientCache.getOrCreateTable(s).applyOperations(i.operations,t);for(const e of n)r.push(e)}return r}async#P(e){const t=function(e,t){const r=new i(t);return e.deserialize(r)}(Ce,e),r=await this.#O(t);if(r)switch(r.tag){case"InitialSubscription":{let e={tag:"SubscribeApplied"};const t=this.#F.eventContextConstructor(this,e),{event:i,...s}=t,n=this.#k(r.tableUpdates,t);this.#m&&this.#I?.(s);for(const e of n)e.cb();break}case"TransactionUpdateLight":{let e={tag:"UnknownTransaction"};const t=this.#F.eventContextConstructor(this,e),i=this.#k(r.tableUpdates,t);for(const e of i)e.cb();break}case"TransactionUpdate":{let e,t,s=r.reducerInfo,n=!1;if(s){t=this.#F.reducers[s.reducerName];try{const r=new i(s.args);e=t.argsType.deserialize(r)}catch{console.debug("Failed to deserialize reducer arguments"),n=!0}}else n=!0;if(n){const e={tag:"UnknownTransaction"},t=this.#F.eventContextConstructor(this,e),i=this.#k(r.tableUpdates,t);for(const e of i)e.cb();return}const a={callerIdentity:r.identity,status:r.status,callerConnectionId:r.connectionId,timestamp:r.timestamp,energyConsumed:r.energyConsumed,reducer:{name:s.reducerName,args:e}},o={tag:"Reducer",value:a},c=this.#F.eventContextConstructor(this,o),p={...c,event:a},u=this.#k(r.tableUpdates,c),l=[];t.argsType.product.elements.forEach(((t,r)=>{l.push(e[t.name])})),this.#B.emit(s.reducerName,p,...l);for(const e of u)e.cb();break}case"IdentityToken":this.identity=r.identity,!this.token&&r.token&&(this.token=r.token),this.connectionId=r.connectionId,this.#m.emit("connect",this,this.identity,this.token);break;case"SubscribeApplied":{const e=this.#E.subscriptions.get(r.queryId);if(void 0===e){je("error",`Received SubscribeApplied for unknown queryId ${r.queryId}.`);break}const t={tag:"SubscribeApplied"},i=this.#F.eventContextConstructor(this,t),{event:s,...n}=i,a=this.#k(r.tableUpdates,i);e?.emitter.emit("applied",n);for(const e of a)e.cb();break}case"UnsubscribeApplied":{const e=this.#E.subscriptions.get(r.queryId);if(void 0===e){je("error",`Received UnsubscribeApplied for unknown queryId ${r.queryId}.`);break}const t={tag:"UnsubscribeApplied"},i=this.#F.eventContextConstructor(this,t),{event:s,...n}=i,a=this.#k(r.tableUpdates,i);e?.emitter.emit("end",n),this.#E.subscriptions.delete(r.queryId);for(const e of a)e.cb();break}case"SubscriptionError":{const e=Error(r.error),t={tag:"Error",value:e},i={...this.#F.eventContextConstructor(this,t),event:e};void 0!==r.queryId?(this.#E.subscriptions.get(r.queryId)?.emitter.emit("error",i,e),this.#E.subscriptions.delete(r.queryId)):(console.error("Received an error message without a queryId: ",e),this.#E.subscriptions.forEach((({emitter:t})=>{t.emit("error",i,e)})))}}}#l(e){this.#M=this.#M.then((()=>this.#P(e.data)))}callReducer(e,t,r){const i=V.CallReducer({reducer:e,args:t,requestId:0,flags:tt(r)});this.#C(i)}disconnect(){this.wsPromise.then((e=>{e&&e.close()}))}#q(e,t){this.#m.on(e,t)}#R(e,t){this.#m.off(e,t)}#N(e){this.#m.on("connect",e)}#D(e){this.#m.on("disconnect",e)}#$(e){this.#m.on("connectError",e)}#L(e){this.#m.off("connect",e)}#j(e){this.#m.off("disconnect",e)}#W(e){this.#m.off("connectError",e)}onReducer(e,t){this.#B.on(e,t)}offReducer(e,t){this.#B.off(e,t)}};export{v as AlgebraicType,Re as AlgebraicValue,i as BinaryReader,s as BinaryWriter,He as ClientCache,d as ConnectionId,Xe as DbConnectionBuilder,rt as DbConnectionImpl,T as Identity,A as ProductType,U as ProductTypeElement,qe as ProductValue,y as ScheduleAt,Je as SubscriptionBuilderImpl,I as SumType,S as SumTypeVariant,We as TableCache,f as TimeDuration,g as Timestamp,n as deepEqual};//# sourceMappingURL=index.js.map